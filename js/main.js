// Generated by CoffeeScript 1.6.2
var Engine, Positioned, Renderable, Resources, System, attachRenderer, testEngine;

Resources = (function() {
  var callbacks, get, load, onReady, ready, resources;

  resources = {};
  callbacks = [];
  ready = function() {
    return _.all(_.values(resources));
  };
  load = function(url) {
    var img;

    if (resources[url]) {
      return resources[url];
    } else {
      img = new Image();
      img.onload = function() {
        var cb, _i, _len, _results;

        resources[url] = img;
        if (ready()) {
          _results = [];
          for (_i = 0, _len = callbacks.length; _i < _len; _i++) {
            cb = callbacks[_i];
            _results.push(cb());
          }
          return _results;
        }
      };
      resources[url] = false;
      return img.src = url;
    }
  };
  get = function(url) {
    return resources[url];
  };
  onReady = function(callback) {
    callbacks.push(callback);
    if (ready() && !_.isEmpty(resources)) {
      return callback();
    }
  };
  return {
    load: load,
    get: get,
    onReady: onReady
  };
})();

Engine = (function() {
  function Engine() {
    this.entities = {};
    this.systems = [];
    this.lastEntityId = 0;
  }

  Engine.prototype.createEntity = function(components) {
    var system, _i, _len, _ref;

    this.entities[this.lastEntityId] = components;
    _ref = this.systems;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      system = _ref[_i];
      system.updateCache(this.lastEntityId, components);
    }
    return this.lastEntityId += 1;
  };

  Engine.prototype.addSystem = function(system) {
    this.systems.push(system);
    return system.buildCache(this.entities);
  };

  Engine.prototype.tick = function() {
    var system, _i, _len, _ref, _results;

    _ref = this.systems;
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      system = _ref[_i];
      _results.push(system.run(this.entities));
    }
    return _results;
  };

  return Engine;

})();

Positioned = (function() {
  function Positioned(pos) {
    this.pos = pos != null ? pos : [0, 0];
  }

  return Positioned;

})();

Renderable = (function() {
  function Renderable(url, pos, size) {
    this.url = url != null ? url : "resources/sun.gif";
    this.pos = pos != null ? pos : [0, 0];
    this.size = size != null ? size : [128, 128];
  }

  return Renderable;

})();

System = (function() {
  function System(satisfies, fn) {
    this.satisfies = satisfies;
    this.fn = fn;
    this.cache = [];
  }

  System.prototype.buildCache = function(entities) {
    var components, id, _results;

    _results = [];
    for (id in entities) {
      components = entities[id];
      if (this.satisfies(components)) {
        _results.push(this.cache.push(id));
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  System.prototype.updateCache = function(id, components) {
    if (this.satisfies(components)) {
      return this.cache.push(id);
    }
  };

  System.prototype.run = function(entities) {
    var id, _i, _len, _ref, _results;

    _ref = this.cache;
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      id = _ref[_i];
      if (_.has(entities, id)) {
        _results.push(this.fn(entities[id]));
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  return System;

})();

attachRenderer = function(engine, canvas) {
  var ctx, renderer;

  ctx = canvas.getContext('2d');
  renderer = new System(function(components) {
    return _.has(components, "renderable") && _.has(components, "positioned");
  }, function(components) {
    var positioned, renderable;

    renderable = components != null ? components.renderable : void 0;
    positioned = components != null ? components.positioned : void 0;
    if (renderable && positioned) {
      return ctx.drawImage(Resources.get(renderable.url), renderable.pos[0], renderable.pos[1], renderable.size[0], renderable.size[1], positioned.pos[0], positioned.pos[1], renderable.size[0], renderable.size[1]);
    } else {
      return console.log("not drawn: " + id);
    }
  });
  return engine.addSystem(renderer);
};

testEngine = function(engine) {
  engine.createEntity({
    "renderable": new Renderable(),
    "positioned": new Positioned()
  });
  engine.createEntity({
    "renderable": new Renderable(),
    "positioned": new Positioned([200, 200])
  });
  engine.createEntity({
    "renderable": new Renderable()
  });
  return engine.tick();
};

/*
//@ sourceMappingURL=main.map
*/
